<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Route Planner 4.0</title>

<script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiqqo0TrHxqpSRrecTKf9ebexIPfKYhcA&libraries=places,geometry"></script>

<style>
:root { --primary:#007AFF; --success:#34C759; --danger:#FF3B30; --bg:#F2F2F7; }
body { font-family:-apple-system,sans-serif; background:var(--bg); margin:0; padding:15px; }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
textarea { width:100%; height:120px; border:1px solid #ddd; border-radius:10px; padding:10px; font-size:14px; box-sizing:border-box; }
.input-group { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }
.btn { border:none; border-radius:8px; padding:12px 5px; color:#fff; font-weight:bold; font-size:12px; cursor:pointer; }
.btn-blue { background:var(--primary); }
.btn-green { background:var(--success); }
.route-item { background:#fafafa; border-left:5px solid #ccc; padding:10px; margin-bottom:10px; border-radius:6px; }
.priority-1 { border-left-color:var(--danger); }
.check-row { display:flex; gap:10px; align-items:flex-start; }
.check-row input { width:22px; height:22px; margin-top:4px; }
#status { font-weight:bold; color:var(--primary); text-align:center; margin-bottom:10px; font-size:13px; }
.hidden { display:none; }
</style>
</head>

<body>

<div class="card">
    <div id="status">üìç –û–∂–∏–¥–∞—é –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤</div>
    <textarea id="textInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ..."></textarea>
    <div class="input-group">
        <button class="btn btn-blue" onclick="fileInput.click()">üñºÔ∏è –§–ê–ô–õ–´</button>
        <button class="btn btn-blue" onclick="cameraInput.click()">üì∑ –ö–ê–ú–ï–†–ê</button>
        <button class="btn btn-green" onclick="buildSmartRoute()">üöÄ –£–ú–ù–´–ô –ü–£–¢–¨</button>
    </div>
    <input type="file" id="fileInput" class="hidden" accept="image/*" multiple onchange="startOCR(this.files)">
    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="startOCR(this.files)">
</div>

<div id="segmentsContainer"></div>

<div class="card">
    <h3>üìã –ú–∞—Ä—à—Ä—É—Ç–Ω—ã–π –ª–∏—Å—Ç</h3>
    <div id="checklistItems"></div>
    <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="copyReport()">üìã –ö–û–ü–ò–†–û–í–ê–¢–¨ –û–¢–ß–ï–¢</button>
</div>

<script>
let allPoints = [];
let userLocation = null;

// 1. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
async function startOCR(files) {
    const status = document.getElementById('status');
    const worker = await Tesseract.createWorker({
        logger: m => { if(m.status === 'recognizing text') status.innerText = `–û–±—Ä–∞–±–æ—Ç–∫–∞: ${Math.round(m.progress*100)}%`; }
    });
    await worker.loadLanguage('deu+rus');
    await worker.initialize('deu+rus');

    for (let i = 0; i < files.length; i++) {
        status.innerText = `–§–æ—Ç–æ ${i+1} –∏–∑ ${files.length}...`;
        const { data: { text } } = await worker.recognize(files[i]);
        document.getElementById('textInput').value += "\n" + text;
    }
    await worker.terminate();
    status.innerText = "–¢–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ '–£–ú–ù–´–ô –ü–£–¢–¨'";
}

// 2. –£–º–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
async function buildSmartRoute() {
    const status = document.getElementById('status');
    status.innerText = "üõ∞Ô∏è –û–ø—Ä–µ–¥–µ–ª—è—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...";

    navigator.geolocation.getCurrentPosition(
        async (pos) => {
            userLocation = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            await processAndSortPoints();
        },
        async (err) => {
            alert("–û—à–∏–±–∫–∞ GPS: " + err.message + ". –ú–∞—Ä—à—Ä—É—Ç –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –±–µ–∑ —É—á–µ—Ç–∞ –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏.");
            await processAndSortPoints();
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

async function processAndSortPoints() {
    const lines = document.getElementById('textInput').value.split('\n');
    const geocoder = new google.maps.Geocoder();
    let tempPoints = [];

    document.getElementById('status').innerText = "üó∫Ô∏è –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤...";

    for (let line of lines) {
        const addr = line.trim();
        if (addr.length < 10) continue;

        const coords = await geocodeAddress(geocoder, addr);
        if (coords) {
            tempPoints.push({
                address: addr,
                label: addr.split(',')[0],
                location: coords,
                done: false
            });
        }
    }

    // –ê–ª–≥–æ—Ä–∏—Ç–º "–ë–ª–∏–∂–∞–π—à–∏–π —Å–æ—Å–µ–¥" –¥–ª—è –ª–æ–≥–∏—á–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
    allPoints = [];
    let currentPos = userLocation || tempPoints[0]?.location;

    while (tempPoints.length > 0) {
        let closestIdx = 0;
        let minDist = Infinity;

        tempPoints.forEach((p, idx) => {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(currentPos, p.location);
            if (dist < minDist) {
                minDist = dist;
                closestIdx = idx;
            }
        });

        const nextPoint = tempPoints.splice(closestIdx, 1)[0];
        allPoints.push(nextPoint);
        currentPos = nextPoint.location;
    }

    document.getElementById('status').innerText = "‚úÖ –ú–∞—Ä—à—Ä—É—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω!";
    render();
}

function geocodeAddress(geocoder, address) {
    return new Promise((resolve) => {
        geocoder.geocode({ address }, (results, status) => {
            if (status === "OK") resolve(results[0].geometry.location);
            else resolve(null);
        });
    });
}

function render() {
    const segs = document.getElementById('segmentsContainer');
    const list = document.getElementById('checklistItems');
    segs.innerHTML = ""; list.innerHTML = "";

    for (let i = 0; i < allPoints.length; i += 9) {
        const chunk = allPoints.slice(i, i + 9);
        const btn = document.createElement('button');
        btn.className = "btn btn-green";
        btn.style = "width:100%; margin-bottom:10px; height:50px; font-size:14px;";
        btn.innerText = `üó∫Ô∏è –°–ï–ì–ú–ï–ù–¢ ${Math.floor(i/9)+1} (–ë–ª–∏–∂–∞–π—à–∏–µ)`;
        btn.onclick = () => openMaps(chunk);
        segs.appendChild(btn);
    }

    allPoints.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = "route-item";
        div.innerHTML = `
            <div class="check-row">
                <input type="checkbox" onchange="allPoints[${idx}].done=this.checked">
                <div>
                    <div class="client-label">${idx + 1}. ${p.label}</div>
                    <div class="address">${p.address}</div>
                </div>
            </div>`;
        list.appendChild(div);
    });
}

function openMaps(points) {
    const origin = "My+Location";
    const dest = encodeURIComponent(points[points.length - 1].address);
    const waypoints = points.slice(0, -1).map(p => encodeURIComponent(p.address)).join('|');
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä optimize:true –ø—Ä–æ—Å–∏—Ç Google –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—É—Ç–∏
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&waypoints=${waypoints}&travelmode=driving&dir_action=navigate`;
    window.open(url, '_blank');
}

function copyReport() {
    const report = allPoints.map((p, i) => `${p.done ? '‚úÖ' : '‚ùå'} ${i+1}. ${p.label}`).join('\n');
    navigator.clipboard.writeText("–û–¢–ß–ï–¢:\n" + report);
    alert("–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
}
</script>
</body>
</html>
