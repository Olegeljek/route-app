<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Route Planner 3.0</title>

<script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiqqo0TrHxqpSRrecTKf9ebexIPfKYhcA&libraries=places"></script>

<style>
:root { --primary:#007AFF; --success:#34C759; --danger:#FF3B30; --bg:#F2F2F7; }
body { font-family:-apple-system,sans-serif; background:var(--bg); margin:0; padding:15px; }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
h2 { margin-top:0; font-size:18px; }
textarea { width:100%; height:120px; border:1px solid #ddd; border-radius:10px; padding:10px; font-size:14px; box-sizing:border-box; }
.input-group { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }
.btn { border:none; border-radius:8px; padding:12px 5px; color:#fff; font-weight:bold; font-size:12px; cursor:pointer; }
.btn-blue { background:var(--primary); }
.btn-green { background:var(--success); }
.btn-gray { background:#8E8E93; }
.route-item { background:#fafafa; border-left:5px solid #ccc; padding:10px; margin-bottom:10px; border-radius:6px; }
.priority-1 { border-left-color:var(--danger); }
.check-row { display:flex; gap:10px; align-items:flex-start; }
.check-row input { width:22px; height:22px; margin-top:4px; }
.client-label { font-weight:bold; }
.address { font-size:12px; color:#555; }
#status { font-weight:bold; color:var(--primary); text-align:center; margin-bottom:10px; font-size:12px; }
.hidden { display:none; }
</style>
</head>

<body>

<div class="card">
    <div id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
    <textarea id="textInput" placeholder="–ê–¥—Ä–µ—Å–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
    <div class="input-group">
        <button class="btn btn-blue" onclick="fileInput.click()">üñºÔ∏è –§–û–¢–û</button>
        <button class="btn btn-blue" onclick="cameraInput.click()">üì∑ –ö–ê–ú–ï–†–ê</button>
        <button class="btn btn-green" onclick="processData()">üöÄ –°–û–ë–†–ê–¢–¨</button>
    </div>
    <input type="file" id="fileInput" class="hidden" accept="image/*" multiple onchange="startOCR(this.files)">
    <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="startOCR(this.files)">
</div>

<div id="segmentsContainer"></div>

<div class="card">
    <h2>üìã –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–æ–∫</h2>
    <div id="checklistItems"></div>
    <button class="btn btn-gray" style="width:100%; margin-top:10px;" onclick="copyReport()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –û–¢–ß–ï–¢</button>
</div>

<script>
let allPoints = [];

async function startOCR(files) {
    const status = document.getElementById('status');
    const worker = await Tesseract.createWorker({
        logger: m => { if(m.status === 'recognizing text') status.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(m.progress*100)}%`; }
    });
    await worker.loadLanguage('deu+rus');
    await worker.initialize('deu+rus');

    for (let i = 0; i < files.length; i++) {
        status.innerText = `–§–æ—Ç–æ ${i+1} –∏–∑ ${files.length}...`;
        const { data: { text } } = await worker.recognize(files[i]);
        document.getElementById('textInput').value += "\n" + text;
    }
    await worker.terminate();
    status.innerText = "–ì–æ—Ç–æ–≤–æ!";
    processData();
}

function processData() {
    const lines = document.getElementById('textInput').value.split('\n');
    allPoints = [];
    lines.forEach((line, idx) => {
        const text = line.trim();
        if (text.length < 10) return;
        let priority = 1;
        if (/–≤–µ—á–µ—Ä|2|evening/i.test(text)) priority = 2;
        allPoints.push({ id: idx, address: text, label: text.split(',')[0], priority, done: false });
    });
    allPoints.sort((a,b) => a.priority - b.priority);
    render();
}

function render() {
    const segs = document.getElementById('segmentsContainer');
    const list = document.getElementById('checklistItems');
    segs.innerHTML = ""; list.innerHTML = "";

    for (let i = 0; i < allPoints.length; i += 9) {
        const chunk = allPoints.slice(i, i + 9);
        const btn = document.createElement('button');
        btn.className = "btn btn-green";
        btn.style = "width:100%; margin-bottom:10px; height:50px; font-size:14px;";
        btn.innerText = `üó∫Ô∏è –ü–£–¢–¨: –°–ï–ì–ú–ï–ù–¢ ${Math.floor(i/9)+1}`;
        btn.onclick = () => openMapsWithGPS(chunk);
        segs.appendChild(btn);
    }

    allPoints.forEach(p => {
        const div = document.createElement('div');
        div.className = `route-item priority-${p.priority}`;
        div.innerHTML = `
            <div class="check-row">
                <input type="checkbox" ${p.done ? 'checked' : ''} onclick="p.done=!p.done">
                <div class="info">
                    <div class="client-label">${p.label}</div>
                    <div class="address">${p.address}</div>
                </div>
            </div>`;
        list.appendChild(div);
    });
}

function openMapsWithGPS(points) {
    // –ó–ê–ü–†–û–° –ì–ï–û–ü–û–ó–ò–¶–ò–ò –ü–ï–†–ï–î –û–¢–ö–†–´–¢–ò–ï–ú
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            // –£—Å–ø–µ—Ö: –∏—Å–ø–æ–ª—å–∑—É–µ–º My Location
            const waypoints = points.slice(0, -1).map(p => encodeURIComponent(p.address)).join('|');
            const dest = encodeURIComponent(points[points.length - 1].address);
            const url = `https://www.google.com/maps?saddr=My+Location&daddr=${dest}&waypoints=${waypoints}&dirflg=d`;
            window.open(url, '_blank');
        },
        (err) => {
            // –û—Ç–∫–∞–∑: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É –∫–∞–∫ —Å—Ç–∞—Ä—Ç
            alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞.");
            const start = encodeURIComponent(points[0].address);
            const waypoints = points.slice(1, -1).map(p => encodeURIComponent(p.address)).join('|');
            const dest = encodeURIComponent(points[points.length - 1].address);
            const url = `https://www.google.com/maps?saddr=${start}&daddr=${dest}&waypoints=${waypoints}&dirflg=d`;
            window.open(url, '_blank');
        },
        { enableHighAccuracy: true, timeout: 5000 }
    );
}

function copyReport() {
    const report = allPoints.map(p => `${p.done ? '‚úÖ' : '‚ùå'} ${p.label}`).join('\n');
    navigator.clipboard.writeText("–û–¢–ß–ï–¢:\n" + report);
    alert("–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
}
</script>
</body>
</html>
