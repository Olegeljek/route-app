<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Route Optimizer 5.0</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiqqo0TrHxqpSRrecTKf9ebexIPfKYhcA&libraries=places,geometry"></script>
    <style>
        :root { --primary:#007AFF; --success:#34C759; --bg:#F2F2F7; }
        body { font-family:-apple-system,sans-serif; background:var(--bg); margin:0; padding:15px; }
        .card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
        textarea { width:100%; height:120px; border:1px solid #ddd; border-radius:10px; padding:10px; box-sizing:border-box; }
        .btn { border:none; border-radius:8px; padding:12px; color:#fff; font-weight:bold; cursor:pointer; width:100%; }
        .btn-blue { background:var(--primary); margin-bottom:10px; }
        .btn-green { background:var(--success); font-size:16px; height:50px; }
        #status { font-weight:bold; color:var(--primary); text-align:center; margin-bottom:10px; }
        .route-item { background:#fafafa; border-left:5px solid #007AFF; padding:10px; margin-bottom:8px; border-radius:6px; font-size:14px; }
    </style>
</head>
<body>

<div class="card">
    <div id="status">üìç –û–∂–∏–¥–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤</div>
    <textarea id="textInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤..."></textarea>
    <div style="margin-top:10px;">
        <button class="btn btn-blue" onclick="document.getElementById('cameraInput').click()">üì∑ –°–î–ï–õ–ê–¢–¨ –§–û–¢–û</button>
        <button class="btn btn-green" onclick="startOptimization()">üöÄ –ü–û–°–¢–†–û–ò–¢–¨ –£–ú–ù–´–ô –ú–ê–†–®–†–£–¢</button>
    </div>
    <input type="file" id="cameraInput" style="display:none" accept="image/*" capture="environment" onchange="runOCR(this.files)">
</div>

<div id="segmentsContainer"></div>
<div class="card"><h3>üìã –û—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</h3><div id="checklistItems"></div></div>

<script>
let allPoints = [];
let userPos = null;

async function runOCR(files) {
    const status = document.getElementById('status');
    const worker = await Tesseract.createWorker();
    await worker.loadLanguage('deu+rus'); await worker.initialize('deu+rus');
    status.innerText = "–†–∞—Å–ø–æ–∑–Ω–∞—é —Ç–µ–∫—Å—Ç...";
    const { data: { text } } = await worker.recognize(files[0]);
    document.getElementById('textInput').value += "\n" + text;
    await worker.terminate();
    status.innerText = "–¢–µ–∫—Å—Ç –≥–æ—Ç–æ–≤!";
}

function startOptimization() {
    const status = document.getElementById('status');
    status.innerText = "üõ∞Ô∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ GPS...";
    
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userPos = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            processAddresses();
        },
        () => {
            alert("GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ú–∞—Ä—à—Ä—É—Ç –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –æ—Ç –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ —Å–ø–∏—Å–∫–∞.");
            processAddresses();
        },
        { enableHighAccuracy: true, timeout: 7000 }
    );
}

async function processAddresses() {
    const status = document.getElementById('status');
    const lines = document.getElementById('textInput').value.split('\n');
    const geocoder = new google.maps.Geocoder();
    let unsortedPoints = [];

    status.innerText = "üó∫Ô∏è –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–∏—Å–∫ –Ω–∞ –∫–∞—Ä—Ç–µ)...";

    for (let line of lines) {
        let addr = line.trim();
        if (addr.length < 10) continue;

        const result = await new Promise(r => {
            geocoder.geocode({address: addr}, (res, st) => r(st === 'OK' ? res[0] : null));
        });

        if (result) {
            unsortedPoints.push({
                address: addr,
                label: addr.split(',')[0],
                loc: result.geometry.location
            });
        }
    }

    if (unsortedPoints.length === 0) {
        status.innerText = "‚ùå –ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Billing!";
        return;
    }

    // –£–ú–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê (–ê–ª–≥–æ—Ä–∏—Ç–º "–ë–ª–∏–∂–∞–π—à–∏–π —Å–æ—Å–µ–¥")
    allPoints = [];
    let currentPoint = userPos || unsortedPoints[0].loc;

    while (unsortedPoints.length > 0) {
        unsortedPoints.sort((a, b) => 
            google.maps.geometry.spherical.computeDistanceBetween(currentPoint, a.loc) - 
            google.maps.geometry.spherical.computeDistanceBetween(currentPoint, b.loc)
        );
        let closest = unsortedPoints.shift();
        allPoints.push(closest);
        currentPoint = closest.loc;
    }

    render();
    status.innerText = "‚úÖ –ú–∞—Ä—à—Ä—É—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω!";
}

function render() {
    const segs = document.getElementById('segmentsContainer');
    const list = document.getElementById('checklistItems');
    segs.innerHTML = ""; list.innerHTML = "";

    // –ù–∞—Ä–µ–∑–∫–∞ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ 9 —Ç–æ—á–µ–∫
    for (let i = 0; i < allPoints.length; i += 9) {
        const chunk = allPoints.slice(i, i + 9);
        const btn = document.createElement('button');
        btn.className = "btn btn-green"; btn.style = "margin-bottom:10px;";
        btn.innerText = `üó∫Ô∏è –°–ï–ì–ú–ï–ù–¢ ${Math.floor(i/9)+1} (–ï–•–ê–¢–¨)`;
        btn.onclick = () => {
            const waypoints = chunk.map(p => encodeURIComponent(p.address)).join('|');
            const dest = encodeURIComponent(chunk[chunk.length - 1].address);
            // –ü–∞—Ä–∞–º–µ—Ç—Ä optimize:true –≤ —Å—Å—ã–ª–∫–µ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ Google
            window.open(`https://www.google.com/maps/dir/?api=1&origin=My+Location&destination=${dest}&waypoints=${waypoints}&travelmode=driving`, '_blank');
        };
        segs.appendChild(btn);
    }

    allPoints.forEach((p, idx) => {
        const div = document.createElement('div');
        div.className = "route-item";
        div.innerHTML = `<b>${idx+1}. ${p.label}</b><br><small>${p.address}</small>`;
        list.appendChild(div);
    });
}
</script>
</body>
</html>
