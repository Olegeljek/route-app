<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Route Planner</title>

<script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiqqo0TrHxqpSRrecTKf9ebexIPfKYhcA&libraries=places"></script>

<style>
:root {
    --primary:#007AFF;
    --success:#34C759;
    --danger:#FF3B30;
    --bg:#F2F2F7;
}
body { font-family:-apple-system,sans-serif; background:var(--bg); margin:0; padding:15px; }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
h2 { margin-top:0; font-size:18px; }

textarea { width:100%; height:120px; border:1px solid #ddd; border-radius:10px; padding:10px; font-size:14px; box-sizing:border-box; }

.input-group { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px; }

.btn {
    border:none; border-radius:8px; padding:12px 5px;
    color:#fff; font-weight:bold; font-size:12px; cursor:pointer;
}
.btn-blue { background:var(--primary); }
.btn-green { background:var(--success); }
.btn-gray { background:#8E8E93; }

.route-item { background:#fafafa; border-left:5px solid #ccc; padding:10px; margin-bottom:10px; border-radius:6px; }
.priority-1 { border-left-color:var(--danger); }
.priority-2 { border-left-color:orange; }

.check-row { display:flex; gap:10px; }
.check-row input { width:22px; height:22px; margin-top:4px; }

.client-label { font-weight:bold; }
.address { font-size:12px; color:#555; }

.comment-box { width:100%; margin-top:5px; font-size:12px; padding:5px; border:1px solid #ddd; border-radius:5px; }

.quick-notes { display:flex; gap:5px; margin-top:5px; }
.note-btn { font-size:10px; background:#eee; border:1px solid #ccc; padding:3px 6px; border-radius:4px; }

.hidden { display:none; }
#loading { font-weight:bold; color:var(--primary); text-align:center; margin-bottom:10px; }
</style>
</head>

<body>

<div class="card">
<h2>üì• –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h2>
<div id="loading" class="hidden"></div>
<textarea id="textInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ..."></textarea>

<div class="input-group">
<button class="btn btn-blue" onclick="document.getElementById('fileInput').click()">üñºÔ∏è –§–æ—Ç–æ</button>
<button class="btn btn-blue" onclick="document.getElementById('cameraInput').click()">üì∑ –ö–∞–º–µ—Ä–∞</button>
<button class="btn btn-green" onclick="processData()">üöÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
</div>

<input type="file" id="fileInput" class="hidden" accept="image/*" multiple onchange="startOCR(this.files)">
<input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment" onchange="startOCR(this.files)">
</div>

<div id="segmentsContainer"></div>

<div class="card">
<h2>üìã –ß–µ–∫-–ª–∏—Å—Ç</h2>
<div id="checklistItems"></div>
<hr>
<button class="btn btn-blue" style="width:100%;margin-bottom:10px" onclick="generateResidualRoute()">üõë –ú–∞—Ä—à—Ä—É—Ç –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º</button>
<button class="btn btn-gray" style="width:100%" onclick="copyReport()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
</div>

<script>
let allPoints = [];

/* ---------- OCR ---------- */

async function startOCR(files) {
    if (!files.length) return;
    const loader = document.getElementById('loading');
    loader.classList.remove('hidden');

    const worker = await Tesseract.createWorker('deu+rus');

    for (let i = 0; i < files.length; i++) {
        loader.innerText = `–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ ${i + 1} –∏–∑ ${files.length}...`;
        const { data:{ text } } = await worker.recognize(files[i]);
        document.getElementById('textInput').value += "\n" + text;
    }

    await worker.terminate();
    loader.classList.add('hidden');
    processData();
}

/* ---------- DATA ---------- */

function processData() {
    const lines = document.getElementById('textInput').value.split('\n');
    const uniqueSet = new Set();
    allPoints = [];

    lines.forEach((line, idx) => {
        const clean = line.trim();
        if (!clean || clean.length < 5) return;

        const normalized = clean.toLowerCase().replace(/\s+/g,' ');
        if (uniqueSet.has(normalized)) return;
        uniqueSet.add(normalized);

        const priority = (clean.match(/(?:^|\s)([1-3])(?:\s|$)/)||[])[1] || 99;
        const deadline = (clean.match(/\d{2}:\d{2}/)||[])[0] || null;
        const isDoctor = /praxis|dr\.|klinik/i.test(clean);

        allPoints.push({
            id: idx,
            address: clean,
            clientLabel: clean.split(',')[0].substring(0,40),
            priority: Number(priority),
            deadline,
            isDoctor,
            done: false,
            comment: ""
        });
    });

    allPoints.sort((a,b)=>{
        if (a.deadline && !b.deadline) return -1;
        if (!a.deadline && b.deadline) return 1;
        if (a.deadline && b.deadline) return a.deadline.localeCompare(b.deadline);
        return a.priority - b.priority;
    });

    render();
}

/* ---------- UI ---------- */

function render() {
    segmentsContainer.innerHTML = "";
    checklistItems.innerHTML = "";

    for (let i=0; i < allPoints.length; i+=9) {
        const segment = allPoints.slice(i, i+9);
        const btn = document.createElement('button');
        btn.className="btn btn-green";
        btn.style="width:100%;margin-bottom:10px;height:50px";
        btn.innerText=`üó∫Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –°–ï–ì–ú–ï–ù–¢ ${Math.floor(i/9)+1}`;
        btn.onclick=()=>openMaps(segment);
        segmentsContainer.appendChild(btn);
    }

    allPoints.forEach(p=>{
        const div=document.createElement('div');
        div.className=`route-item priority-${p.priority}`;
        div.innerHTML=`
        <div class="check-row">
            <input type="checkbox" ${p.done?'checked':''} onchange="toggleDone(${p.id})">
            <div style="flex:1">
                <div class="client-label">${p.isDoctor?'üè•':'üè†'} ${p.clientLabel}</div>
                <div class="address">${p.address}</div>
                <input class="comment-box" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${p.comment}" onchange="updateComment(${p.id},this.value)">
            </div>
        </div>`;
        checklistItems.appendChild(div);
    });
}

/* ---------- ACTIONS ---------- */

function openMaps(points) {
    if (!points.length) return;

    // –°–¢–ê–†–¢: –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ GPS
    const origin = "My+Location";
    
    // –ü–£–¢–ï–í–´–ï –¢–û–ß–ö–ò: –í—Å–µ —Ç–æ—á–∫–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
    const waypoints = points.map(p => encodeURIComponent(p.address)).join('|');
    
    // –§–ò–ù–ò–®: –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞
    const destination = encodeURIComponent(points[points.length - 1].address);

    // –ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ Google Maps API —Å –∞–≤—Ç–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
    const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}&travelmode=driving&dir_action=navigate`;
    
    window.open(url, '_blank');
}

function toggleDone(id){
    const p=allPoints.find(x=>x.id===id);
    p.done=!p.done;
    render();
}
function updateComment(id,t){ allPoints.find(x=>x.id===id).comment=t; }

function generateResidualRoute(){
    const rest=allPoints.filter(p=>!p.done);
    if(rest.length) openMaps(rest); else alert("–í—Å–µ –∞–¥—Ä–µ—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!");
}

function copyReport(){
    let r="–û–¢–ß–ï–¢ –ü–û –ú–ê–†–®–†–£–¢–£:\n";
    allPoints.forEach(p=>{
        r+=`${p.done?'‚úÖ':'‚ùå'} ${p.clientLabel} | ${p.comment}\n`;
    });
    navigator.clipboard.writeText(r);
    alert("–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞");
}
</script>
</body>
</html>
